<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.back.mapper.OmsOrderMapper">

    <resultMap id="BaseResultMap" type="com.example.back.entity.oms.OmsOrder">
        <id column="id" property="id"/>
        <result column="order_sn" property="orderSn"/>
        <result column="member_id" property="memberId"/>
        <result column="staff_id" property="staffId"/>
        <result column="service_id" property="serviceId"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="pay_amount" property="payAmount"/>
        <result column="status" property="status"/>
        <result column="appointment_time" property="appointmentTime"/>
        <result column="address_info" property="addressInfo"/>
        <result column="ext_info" property="extInfo"/>
        <result column="create_time" property="createTime"/>
        <result column="service_title" property="serviceTitle"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO oms_order (order_sn, member_id, staff_id, service_id, total_amount, pay_amount, status,
                              appointment_time, address_info, ext_info)
        VALUES (#{orderSn}, #{memberId}, #{staffId}, #{serviceId}, #{totalAmount}, #{payAmount}, #{status},
                #{appointmentTime}, #{addressInfo}, #{extInfo})
    </insert>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT o.id, o.order_sn, o.member_id, o.staff_id, o.service_id, o.total_amount, o.pay_amount,
               o.status, o.appointment_time, o.address_info, o.ext_info, o.create_time,
               s.title AS service_title
        FROM oms_order o
        LEFT JOIN pms_service s ON o.service_id = s.id
        WHERE o.id = #{id}
    </select>

    <select id="selectByOrderSn" resultMap="BaseResultMap">
        SELECT o.id, o.order_sn, o.member_id, o.staff_id, o.service_id, o.total_amount, o.pay_amount,
               o.status, o.appointment_time, o.address_info, o.ext_info, o.create_time,
               s.title AS service_title
        FROM oms_order o
        LEFT JOIN pms_service s ON o.service_id = s.id
        WHERE o.order_sn = #{orderSn}
    </select>

    <select id="selectByMemberId" resultMap="BaseResultMap">
        SELECT o.id, o.order_sn, o.member_id, o.staff_id, o.service_id, o.total_amount, o.pay_amount,
               o.status, o.appointment_time, o.address_info, o.ext_info, o.create_time,
               s.title AS service_title
        FROM oms_order o
        LEFT JOIN pms_service s ON o.service_id = s.id
        WHERE o.member_id = #{memberId}
        <if test="status != null">
            AND o.status = #{status}
        </if>
        ORDER BY o.create_time DESC
    </select>

    <update id="updateStatus">
        UPDATE oms_order SET status = #{status} WHERE id = #{id}
    </update>

    <!-- 服务人员接单（抢单），通过状态和 staff_id 判定防止重复接单 -->
    <update id="grabOrder">
        UPDATE oms_order
        SET staff_id = #{staffId},
            status   = 30
        WHERE id = #{id}
          AND status = #{expectedStatus}
          AND staff_id IS NULL
    </update>

</mapper>
